# MarketplaceEscrowV1 Smart Contract

A comprehensive marketplace escrow smart contract for Stellar blockchain featuring buyer/seller registry, 3-way document matching, and Delivery vs Payment (DvP) settlement.

## Features

### Registry System
- **Buyer Registration**: Register buyers with name and LEI ID (Legal Entity Identifier)
- **Seller Registration**: Register sellers with name and LEI ID
- **Active Status Management**: Deactivate buyers/sellers without deleting data
- **Query Functions**: List all registered buyers and sellers

### Trade Lifecycle
1. **ORDERED**: Buyer creates purchase order and funds escrow
2. **FULFILLED**: Seller ships goods and submits Customer Invoice + Warehouse Receipt
3. **SETTLED**: 3-way matching passes, payment automatically released
4. **REJECTED**: Seller rejects the order (funds refunded)
5. **CANCELLED**: Buyer cancels before fulfillment (funds refunded)

### Document Management
- **Purchase Order (PO)**: Created by buyer with IPFS hash
- **Customer Invoice (CI)**: Generated by seller with IPFS hash
- **Warehouse Receipt (WR)**: Generated by seller with IPFS hash
- **vLEI Documents**: GLEIF validation credentials with IPFS hashes

### 3-Way Matching with Variance
The contract performs automated 3-way matching between PO, CI, and WR:
- **Description**: EXACT match required (case-sensitive)
- **Quantity**: ≤5% variance allowed between any two documents
- **Total Price**: ≤2% variance allowed between any two documents

### DvP Settlement
- **dvp_check()**: Validates all documents exist and calls three_way_match()
- **three_way_match()**: Performs matching with variance calculations
- **Automatic Payment**: Releases funds to seller and marketplace fee to treasury

## Contract Structure

```
src/
├── lib.rs           # Entry point
├── contract.rs      # Main contract implementation
├── types.rs         # Data structures
├── storage.rs       # Storage keys
├── registry.rs      # Buyer/seller registration
├── trade.rs         # Trade lifecycle functions
├── matching.rs      # DvP and 3-way matching logic
├── errors.rs        # Custom error types
└── test.rs          # Comprehensive tests
```

## Data Structures

### BuyerInfo
```rust
{
    name: String,              // "Tommy Hilfiger"
    lei_id: String,           // "549300VGEJK8QMIYGZ34"
    wallet_address: Address,
    registered_at: u64,
    is_active: bool,
}
```

### SellerInfo
```rust
{
    name: String,              // "Jupiter Knitting"
    lei_id: String,           // "213800ABCDEF1234XYZ"
    wallet_address: Address,
    registered_at: u64,
    is_active: bool,
}
```

### TradeEscrow
```rust
{
    trade_id: u64,
    buyer: Address,
    seller: Address,
    amount: i128,
    state: u32,              // ORDERED, FULFILLED, SETTLED, REJECTED, CANCELLED
    created_at: u64,
    fulfilled_at: u64,
    settled_at: u64,
    marketplace_fee: i128,
    escrow_balance: i128,
}
```

## Usage Example

### 1. Initialize Contract
```rust
// Deploy and initialize with treasury address and fee rate
MarketplaceEscrowV1::constructor(
    treasury_address,
    25  // 0.25% marketplace fee
);
```

### 2. Register Parties
```rust
// Register buyer (admin only)
register_buyer(
    buyer_address,
    "Tommy Hilfiger",
    "549300VGEJK8QMIYGZ34"
);

// Register seller (admin only)
register_seller(
    seller_address,
    "Jupiter Knitting",
    "213800ABCDEF1234XYZ"
);
```

### 3. Create Trade (Buyer)
```rust
let trade_id = create_trade(
    seller_address,
    "Cotton T-shirts, Blue, Size M",
    1000,                    // quantity
    15_0000000,             // unit price (15 XLM in stroops)
    15000_0000000,          // total price
    "QmPO_IPFS_Hash",
    "QmBuyerLEI_IPFS_Hash",
    "QmSellerLEI_IPFS_Hash"
);
```

### 4. Fund Escrow (Buyer)
```rust
// Calculate required amount (includes marketplace fee)
let (total_required, fee) = calculate_escrow_cost(15000_0000000);

// Fund the escrow
fund_escrow(trade_id, total_required);
```

### 5. Validate vLEI
```rust
// Seller validates buyer
validate_buyer_vlei(trade_id);

// Buyer validates seller
validate_seller_vlei(trade_id);
```

### 6. Fulfill Order (Seller)
```rust
fulfill_order(
    trade_id,
    "Cotton T-shirts, Blue, Size M",  // CI description (must match PO)
    1000,                               // CI quantity
    15_0000000,                         // CI unit price
    15000_0000000,                      // CI total price
    "QmCI_IPFS_Hash",
    "Cotton T-shirts, Blue, Size M",  // WR description (must match PO)
    1000,                               // WR quantity
    15_0000000,                         // WR unit price
    15000_0000000,                      // WR total price
    "QmWR_IPFS_Hash",
    "Warehouse A, Mumbai"
);
```

### 7. Accept Trade (Buyer triggers DvP)
```rust
// This calls dvp_check() → three_way_match() → release_payment()
accept_trade(trade_id);
```

## Variance Examples

### Quantity Variance (5% tolerance)
✅ **PASS**: PO=1000, CI=1040 → Variance = 4.0%  
❌ **FAIL**: PO=1000, WR=1060 → Variance = 6.0%

### Price Variance (2% tolerance)
✅ **PASS**: PO=15000, CI=15250 → Variance = 1.67%  
❌ **FAIL**: PO=15000, WR=15350 → Variance = 2.33%

## Error Codes

| Code | Error | Description |
|------|-------|-------------|
| 1 | BuyerNotRegistered | Buyer address not in registry |
| 2 | SellerNotRegistered | Seller address not in registry |
| 3 | BuyerAlreadyRegistered | Buyer already exists |
| 4 | SellerAlreadyRegistered | Seller already exists |
| 5 | BuyerInactive | Buyer deactivated |
| 6 | SellerInactive | Seller deactivated |
| 20 | Unauthorized | Caller not authorized |
| 21 | NotContractOwner | Only owner can perform action |
| 22 | NotBuyer | Only buyer can perform action |
| 23 | NotSeller | Only seller can perform action |
| 40 | InvalidTradeState | Trade not in required state |
| 41 | TradeNotFound | Trade ID doesn't exist |
| 60 | InsufficientEscrowFunding | Payment amount too low |
| 61 | EscrowNotFunded | Escrow must be funded first |
| 80 | PurchaseOrderNotFound | PO document missing |
| 81 | CustomerInvoiceNotFound | CI document missing |
| 82 | WarehouseReceiptNotFound | WR document missing |
| 84 | BuyerVLEINotValidated | Buyer vLEI not validated |
| 100 | DescriptionMismatch | PO/CI/WR descriptions don't match |
| 101 | QuantityVarianceTooHigh | Quantity variance exceeds 5% |
| 102 | PriceVarianceTooHigh | Price variance exceeds 2% |

## Testing

Run the test suite:
```bash
cargo test
```

### Test Coverage
- ✅ Contract initialization
- ✅ Buyer/seller registration
- ✅ Duplicate registration prevention
- ✅ Trade creation
- ✅ Escrow funding
- ✅ Order fulfillment
- ✅ Exact match acceptance
- ✅ Variance tolerance (4% quantity, 1.67% price)
- ✅ Description mismatch failure
- ✅ Order rejection
- ✅ Trade cancellation

## Building & Deployment

### Build the contract
```bash
stellar contract build
```

### Deploy to testnet
```bash
stellar contract deploy \
  --wasm target/wasm32-unknown-unknown/release/marketplace_escrow_v1.wasm \
  --network testnet
```

### Initialize after deployment
```bash
stellar contract invoke \
  --id <CONTRACT_ID> \
  --network testnet \
  -- constructor \
  --treasury <TREASURY_ADDRESS> \
  --marketplace_fee_rate 25
```

## Security Considerations

1. **Authorization**: All state-changing functions verify caller authorization
2. **Access Control**: Only contract owner can register/deactivate buyers/sellers
3. **State Validation**: Trade state transitions are strictly enforced
4. **Arithmetic Safety**: All calculations use checked math to prevent overflow
5. **Immutable Documents**: Once stored, documents cannot be modified

## License

Apache-2.0

## Version

0.0.1
